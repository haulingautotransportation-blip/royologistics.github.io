<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Carrier Dashboard – RoYo Logistics</title>
  <!-- <link rel="stylesheet" href="styles.css" /> -->
</head>
<body>

  <main class="container" style="padding: 80px 20px; max-width: 1100px;">
    <div style="display:flex; align-items:center; gap:12px;">
      <h1 data-i18n="title">Carrier Dashboard</h1>
      <span id="userEmail" style="margin-left:auto; color:#cbd5e1;"></span>
      <button id="logoutBtn" type="button" class="btn ghost" data-i18n="logout">Logout</button>
    </div>

    <!-- Language switch -->
    <div style="display:flex; gap:10px; margin: 14px 0 26px;">
      <button type="button" class="lang-btn active" data-lang="en">EN</button>
      <button type="button" class="lang-btn" data-lang="ru">RU</button>
      <button type="button" class="lang-btn" data-lang="uz">UZ</button>
    </div>

    <p class="subtitle" data-i18n="subtitle">Welcome to your carrier workspace</p>
    <p id="profileMini" style="color:#cbd5e1; margin-top:8px; opacity:.95;"></p>

    <!-- Top cards -->
    <div class="dashboard-grid">
      <div class="dashboard-card">
        <h3 data-i18n="card_profile">Carrier Profile</h3>
        <p data-i18n="card_profile_desc">Manage company info, vehicle details, and contacts.</p>
        <a class="btn" href="carrier-profile.html" data-i18n="btn_open">Open</a>
      </div>

      <div class="dashboard-card">
        <h3 data-i18n="card_loads">Available Loads</h3>
        <p data-i18n="card_loads_desc">Browse and accept available shipments in real time.</p>
        <button id="btnGoLoads" type="button" class="btn" data-i18n="btn_view_loads">View Loads</button>
      </div>

      <div class="dashboard-card">
        <h3 data-i18n="card_shipments">My Shipments</h3>
        <p data-i18n="card_shipments_desc">Track active, completed, and pending loads.</p>
        <a class="btn" href="shipments.html" data-i18n="btn_track">Track</a>
      </div>

      <div class="dashboard-card">
        <h3 data-i18n="card_docs">Documents</h3>
        <p data-i18n="card_docs_desc">Upload insurance and compliance documents.</p>
        <a class="btn" href="documents.html" data-i18n="btn_upload">Upload</a>
      </div>

      <div class="dashboard-card">
        <h3 data-i18n="card_payments">Payments</h3>
        <p data-i18n="card_payments_desc">View payment history and upcoming settlements.</p>
        <a class="btn" href="payments.html" data-i18n="btn_view">View</a>
      </div>

      <div class="dashboard-card">
        <h3 data-i18n="card_support">Support</h3>
        <p data-i18n="card_support_desc">Contact dispatch or account support.</p>
        <a class="btn" href="support.html" data-i18n="btn_contact">Contact</a>
      </div>
    </div>

    <!-- REAL DATA: Open Loads list -->
    <section id="loadsSection" style="margin-top: 28px;">
      <h2 style="color:#fff; margin-bottom: 10px;" data-i18n="loads_list_title">Available Loads</h2>

      <div id="loadsList" class="dashboard-grid"></div>

      <p id="loadsEmpty" style="color:#cbd5e1; display:none;" data-i18n="loads_empty">
        No open loads right now.
      </p>
    </section>

    <a href="index.html" style="display:inline-block;margin-top:40px; color:#bfdbfe;" data-i18n="back_home">← Back to Home</a>
  </main>

  <!-- AUTH + ROLE PROTECTION + FIRESTORE LOADS + MINI PROFILE -->
  <script type="module">
    import { auth, db } from "./firebase.js";
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import {
      doc, getDoc,
      collection, query, where, orderBy, limit, getDocs
    } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

    const emailEl = document.getElementById("userEmail");
    const profileMini = document.getElementById("profileMini");

    // language-aware labels for dynamic text
    const uiText = {
      lang: localStorage.getItem("lang") || "en",
      profileLabel: {
        en: "Profile",
        ru: "Профиль",
        uz: "Profil"
      },
      equipmentLabel: {
        en: "Equipment",
        ru: "Кузов",
        uz: "Transport"
      },
      priceLabel: {
        en: "Price",
        ru: "Цена",
        uz: "Narx"
      },
      viewBtn: {
        en: "View",
        ru: "Смотреть",
        uz: "Ko‘rish"
      }
    };

    async function getRole(uid) {
      const snap = await getDoc(doc(db, "users", uid));
      return snap.exists() ? snap.data().role : null;
    }

    async function loadMiniProfile(uid) {
      if (!profileMini) return;

      const snap = await getDoc(doc(db, "carriers", uid));
      if (!snap.exists()) {
        profileMini.textContent = "";
        return;
      }

      const d = snap.data();
      const name = d.name || "";
      const vehicle = d.vehicleType || "";

      const lang = localStorage.getItem("lang") || "en";
      const label = uiText.profileLabel[lang] || uiText.profileLabel.en;

      profileMini.textContent =
        name && vehicle
          ? `${label}: ${name} • ${vehicle}`
          : name
          ? `${label}: ${name}`
          : "";
    }

    async function loadOpenLoads() {
      const loadsList = document.getElementById("loadsList");
      const loadsEmpty = document.getElementById("loadsEmpty");
      if (!loadsList || !loadsEmpty) return;

      loadsList.innerHTML = "";

      const q = query(
        collection(db, "loads"),
        where("status", "==", "open"),
        orderBy("createdAt", "desc"),
        limit(12)
      );

      const snap = await getDocs(q);

      if (snap.empty) {
        loadsEmpty.style.display = "block";
        return;
      }

      loadsEmpty.style.display = "none";

      const lang = localStorage.getItem("lang") || "en";
      const equipmentLabel = uiText.equipmentLabel[lang] || uiText.equipmentLabel.en;
      const priceLabel = uiText.priceLabel[lang] || uiText.priceLabel.en;
      const viewBtnText = uiText.viewBtn[lang] || uiText.viewBtn.en;

      snap.forEach(docc => {
        const d = docc.data();
        const pickup = d.pickupCity || "-";
        const delivery = d.deliveryCity || "-";
        const equipment = d.equipment || "-";
        const price = (d.price ?? "-");

        const card = document.createElement("div");
        card.className = "dashboard-card";
        card.innerHTML = `
          <h3>${pickup} → ${delivery}</h3>
          <p>${equipmentLabel}: ${equipment}</p>
          <p>${priceLabel}: $${price}</p>
          <button type="button" class="btn btn-small" onclick="location.href='load.html?id=${docc.id}'">
            ${viewBtnText}
          </button>
        `;
        loadsList.appendChild(card);
      });
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.replace("login.html");
        return;
      }

      emailEl.textContent = user.email ? `Logged in as: ${user.email}` : "";

      const role = await getRole(user.uid);
      if (role !== "carrier") {
        window.location.replace("login.html");
        return;
      }

      await loadMiniProfile(user.uid);
      await loadOpenLoads();
    });

    // Logout
    document.getElementById("logoutBtn")?.addEventListener("click", async () => {
      await signOut(auth);
      window.location.replace("login.html");
    });

    // Scroll to loads
    document.getElementById("btnGoLoads")?.addEventListener("click", () => {
      document.getElementById("loadsSection")?.scrollIntoView({ behavior: "smooth" });
    });

    // update dynamic labels when language changes
    window.addEventListener("storage", async (e) => {
      if (e.key === "lang") {
        await loadMiniProfile(auth.currentUser?.uid);
        await loadOpenLoads();
      }
    });
  </script>

  <!-- i18n -->
  <script>
    const i18n = {
      en: {
        title: "Carrier Dashboard",
        logout: "Logout",
        subtitle: "Welcome to your carrier workspace",
        card_profile: "Carrier Profile",
        card_profile_desc: "Manage company info, vehicle details, and contacts.",
        card_loads: "Available Loads",
        card_loads_desc: "Browse and accept available shipments in real time.",
        card_shipments: "My Shipments",
        card_shipments_desc: "Track active, completed, and pending loads.",
        card_docs: "Documents",
        card_docs_desc: "Upload insurance and compliance documents.",
        card_payments: "Payments",
        card_payments_desc: "View payment history and upcoming settlements.",
        card_support: "Support",
        card_support_desc: "Contact dispatch or account support.",
        btn_open: "Open",
        btn_view_loads: "View Loads",
        btn_track: "Track",
        btn_upload: "Upload",
        btn_view: "View",
        btn_contact: "Contact",
        back_home: "← Back to Home",
        loads_list_title: "Available Loads",
        loads_empty: "No open loads right now."
      },
      ru: {
        title: "Кабинет перевозчика",
        logout: "Выйти",
        subtitle: "Добро пожаловать в рабочее пространство перевозчика",
        card_profile: "Профиль перевозчика",
        card_profile_desc: "Данные компании, авто и контакты.",
        card_loads: "Доступные грузы",
        card_loads_desc: "Просматривайте и принимайте перевозки в реальном времени.",
        card_shipments: "Мои перевозки",
        card_shipments_desc: "Отслеживайте активные, завершённые и ожидающие рейсы.",
        card_docs: "Документы",
        card_docs_desc: "Загружайте страховку и документы по комплаенсу.",
        card_payments: "Платежи",
        card_payments_desc: "Смотрите историю выплат и предстоящие расчёты.",
        card_support: "Поддержка",
        card_support_desc: "Свяжитесь с диспетчером или поддержкой.",
        btn_open: "Открыть",
        btn_view_loads: "Смотреть грузы",
        btn_track: "Отслеживать",
        btn_upload: "Загрузить",
        btn_view: "Смотреть",
        btn_contact: "Связаться",
        back_home: "← На главную",
        loads_list_title: "Доступные грузы",
        loads_empty: "Сейчас нет доступных грузов."
      },
      uz: {
        title: "Tashuvchi paneli",
        logout: "Chiqish",
        subtitle: "Tashuvchi ish maydoniga xush kelibsiz",
        card_profile: "Tashuvchi profili",
        card_profile_desc: "Kompaniya, transport va kontakt ma’lumotlarini boshqaring.",
        card_loads: "Mavjud yuklar",
        card_loads_desc: "Yuklarni ko‘ring va real vaqtda qabul qiling.",
        card_shipments: "Mening yuklarim",
        card_shipments_desc: "Faol, yakunlangan va kutilayotgan yuklarni kuzating.",
        card_docs: "Hujjatlar",
        card_docs_desc: "Sug‘urta va moslik (compliance) hujjatlarini yuklang.",
        card_payments: "To‘lovlar",
        card_payments_desc: "To‘lovlar tarixini va yaqin to‘lovlarni ko‘ring.",
        card_support: "Yordam",
        card_support_desc: "Dispetcher yoki qo‘llab-quvvatlash bilan bog‘laning.",
        btn_open: "Ochish",
        btn_view_loads: "Yuklarni ko‘rish",
        btn_track: "Kuzatish",
        btn_upload: "Yuklash",
        btn_view: "Ko‘rish",
        btn_contact: "Bog‘lanish",
        back_home: "← Bosh sahifaga",
        loads_list_title: "Mavjud yuklar",
        loads_empty: "Hozircha ochiq yuklar yo‘q."
      }
    };

    function applyLang(lang) {
      const dict = i18n[lang] || i18n.en;

      document.querySelectorAll("[data-i18n]").forEach(el => {
        const key = el.getAttribute("data-i18n");
        if (dict[key]) el.textContent = dict[key];
      });

      document.querySelectorAll(".lang-btn").forEach(b => {
        b.classList.toggle("active", b.dataset.lang === lang);
      });

      localStorage.setItem("lang", lang);

      // reload page dynamic parts (mini profile + loads) will update due to storage listener,
      // but some browsers don't fire storage in same tab, so we force reload:
      location.reload();
    }

    document.querySelectorAll(".lang-btn").forEach(btn => {
      btn.addEventListener("click", () => applyLang(btn.dataset.lang));
    });

    applyLang(localStorage.getItem("lang") || "en");
  </script>

</body>
</html>
