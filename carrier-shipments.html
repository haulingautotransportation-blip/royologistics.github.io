<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Shipments – RoYo Logistics</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>

  <main id="page" class="container" style="padding:80px 20px; max-width:1100px; display:none;">

    <div style="display:flex; align-items:center; gap:12px;">
      <h1 data-i18n="myShipments">My Shipments</h1>
      <a href="carrier-dashboard.html" class="btn ghost" style="margin-left:auto;" data-i18n="backDash">Back</a>
    </div>

    <div id="shipmentsEmpty" style="display:none; margin-top:20px; color:#cbd5e1;" data-i18n="noShipments">
      No accepted shipments yet.
    </div>

    <div id="shipmentsList" style="margin-top:20px;"></div>

  </main>

  <!-- i18n (NO reload) -->
  <script>
    const i18n = {
      en: {
        myShipments: "My Shipments",
        noShipments: "No accepted shipments yet.",
        backDash: "Back",
        open: "Open",
        updateStatus: "Update Status",
        accepted: "Accepted",
        inTransit: "In Transit",
        delivered: "Delivered",
        errorLoading: "Error loading shipments"
      },
      ru: {
        myShipments: "Мои перевозки",
        noShipments: "Пока нет принятых перевозок.",
        backDash: "Назад",
        open: "Открыть",
        updateStatus: "Обновить статус",
        accepted: "Принято",
        inTransit: "В пути",
        delivered: "Доставлено",
        errorLoading: "Ошибка загрузки перевозок"
      },
      uz: {
        myShipments: "Mening yuklarim",
        noShipments: "Hozircha qabul qilingan yuklar yo‘q.",
        backDash: "Orqaga",
        open: "Ochish",
        updateStatus: "Statusni yangilash",
        accepted: "Qabul qilindi",
        inTransit: "Yo‘lda",
        delivered: "Yetkazildi",
        errorLoading: "Yuklarni yuklashda xatolik"
      }
    };

    function getLang() {
      return localStorage.getItem("lang") || "en";
    }

    function t(key) {
      const lang = getLang();
      return (i18n[lang] && i18n[lang][key]) || i18n.en[key] || key;
    }

    function applyLang(lang) {
      const dict = i18n[lang] || i18n.en;
      document.querySelectorAll("[data-i18n]").forEach(el => {
        const key = el.getAttribute("data-i18n");
        if (dict[key]) el.textContent = dict[key];
      });
      localStorage.setItem("lang", lang);
    }

    applyLang(getLang());
  </script>

  <!-- Firebase logic (single source of truth) -->
  <script type="module">
    import { auth, db } from "./firebase.js";
    import {
      collection, query, where, getDocs,
      doc, updateDoc
    } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";

    const page = document.getElementById("page");
    const shipmentsList = document.getElementById("shipmentsList");
    const shipmentsEmpty = document.getElementById("shipmentsEmpty");

    let currentUser = null;

    function statusLabel(st){
      const s = (st || "accepted").toLowerCase();
      if (s === "accepted") return window.t("accepted");
      if (s === "in_transit") return window.t("inTransit");
      if (s === "delivered") return window.t("delivered");
      return s;
    }

    async function getAcceptedLoadsForUser(user) {
      // 1) Try UID match (your current design: acceptedBy == uid)
      const qUid = query(
        collection(db, "loads"),
        where("acceptedBy", "==", user.uid)
      );
      const snapUid = await getDocs(qUid);
      if (!snapUid.empty) return snapUid;

      // 2) Fallback: some versions store acceptedByEmail instead
      const email = (user.email || "").toLowerCase();
      if (!email) return snapUid;

      const qEmail = query(
        collection(db, "loads"),
        where("acceptedByEmail", "==", email)
      );
      const snapEmail = await getDocs(qEmail);
      return snapEmail;
    }

    async function loadShipments() {
      shipmentsList.innerHTML = "";
      shipmentsEmpty.style.display = "none";

      if (!currentUser) {
        shipmentsEmpty.style.display = "block";
        return;
      }

      try {
        const snap = await getAcceptedLoadsForUser(currentUser);

        if (snap.empty) {
          shipmentsEmpty.style.display = "block";
          return;
        }

        // Client-side sort (avoid Firestore orderBy/index issues)
        const rows = [];
        snap.forEach(docc => {
          const d = docc.data();
          const acceptedAt = d.acceptedAt?.seconds ? d.acceptedAt.seconds : 0;
          const createdAt = d.createdAt?.seconds ? d.createdAt.seconds : 0;
          const sortKey = acceptedAt || createdAt || 0;
          rows.push({ id: docc.id, data: d, sortKey });
        });
        rows.sort((a,b) => (b.sortKey || 0) - (a.sortKey || 0));

        rows.forEach(({ id, data: d }) => {
          const st = (d.status || "accepted").toLowerCase();
          const canUpdate = st !== "delivered";

          const card = document.createElement("div");
          card.className = "dashboard-card";
          card.style.marginBottom = "10px";

          card.innerHTML = `
            <h3 style="margin-bottom:8px;">
              ${d.pickupCity || "-"} → ${d.deliveryCity || "-"}
            </h3>

            <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
              <span class="status-badge status-${st}">${d.currentStatus || statusLabel(st)}</span>
              ${canUpdate ? `<button class="btn btn-small" data-advance="1">${window.t("updateStatus")}</button>` : ""}
              <a class="btn ghost btn-small" href="load.html?id=${id}">${window.t("open")}</a>
            </div>
          `;

          const btn = card.querySelector('[data-advance="1"]');
          if (btn) {
            btn.addEventListener("click", async () => {
              btn.disabled = true;

              const next =
                st === "accepted"
                  ? { status: "in_transit", currentStatus: statusLabel("in_transit") }
                  : { status: "delivered", currentStatus: statusLabel("delivered") };

              try {
                await updateDoc(doc(db, "loads", id), next);
                await loadShipments();
              } catch (e) {
                console.error(e);
                btn.disabled = false;
                alert("Could not update status.");
              }
            });
          }

          shipmentsList.appendChild(card);
        });

      } catch (e) {
        shipmentsEmpty.style.display = "block";
        shipmentsEmpty.textContent = window.t("errorLoading");
        console.error(e);
      }
    }

    onAuthStateChanged(auth, async user => {
      currentUser = user || null;
      page.style.display = "block";
      await loadShipments();
    });
  </script>

</body>
</html>
