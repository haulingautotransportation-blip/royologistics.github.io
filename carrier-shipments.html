<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Shipments – RoYo Logistics</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>

  <main id="page" class="container" style="padding:80px 20px; max-width:1100px; display:none;">

    <div style="display:flex; align-items:center; gap:12px;">
      <h1 data-i18n="myShipments">My Shipments</h1>
      <a href="carrier-dashboard.html" class="btn ghost" style="margin-left:auto;" data-i18n="backDash">Back</a>
    </div>

    <div id="shipmentsEmpty" style="display:none; margin-top:20px; color:#cbd5e1;" data-i18n="noShipments">
      No accepted shipments yet.
    </div>

    <div id="shipmentsList" style="margin-top:20px;"></div>

  </main>

  <!-- i18n (NO reload) -->
  <script>
    const i18n = {
      en: { myShipments: "My Shipments", noShipments: "No accepted shipments yet.", backDash: "Back" },
      ru: { myShipments: "Мои перевозки", noShipments: "Пока нет принятых перевозок.", backDash: "Назад" },
      uz: { myShipments: "Mening yuklarim", noShipments: "Hozircha qabul qilingan yuklar yo‘q.", backDash: "Orqaga" }
    };

    function applyLang(lang) {
      const dict = i18n[lang] || i18n.en;
      document.querySelectorAll("[data-i18n]").forEach(el => {
        const key = el.getAttribute("data-i18n");
        if (dict[key]) el.textContent = dict[key];
      });
      localStorage.setItem("lang", lang);
    }

    applyLang(localStorage.getItem("lang") || "en");
  </script>

  <!-- Firebase logic -->
  <script type="module">
    import { auth, db } from "./firebase.js";
    import {
      collection, query, where, orderBy, getDocs,
      doc, updateDoc
    } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";

    const page = document.getElementById("page");
    const shipmentsList = document.getElementById("shipmentsList");
    const shipmentsEmpty = document.getElementById("shipmentsEmpty");

    let currentUser = null;

    function statusLabel(st){
      const s = (st || "accepted").toLowerCase();
      if (s === "accepted") return "Accepted";
      if (s === "in_transit") return "In Transit";
      if (s === "delivered") return "Delivered";
      return s;
    }

    async function loadShipments() {
      shipmentsList.innerHTML = "";
      shipmentsEmpty.style.display = "none";

      if (!currentUser) {
        shipmentsEmpty.style.display = "block";
        return;
      }

      try {
        const q = query(
          collection(db, "loads"),
          where("acceptedBy", "==", currentUser.uid),
          orderBy("acceptedAt", "desc")
        );

        const snap = await getDocs(q);

        if (snap.empty) {
          shipmentsEmpty.style.display = "block";
          return;
        }

        snap.forEach(docc => {
          const d = docc.data();
          const st = (d.status || "accepted").toLowerCase();

          const card = document.createElement("div");
          card.className = "dashboard-card";
          card.style.marginBottom = "10px";

          const canUpdate = st !== "delivered";

          card.innerHTML = `
            <h3 style="margin-bottom:8px;">
              ${d.pickupCity || "-"} → ${d.deliveryCity || "-"}
            </h3>

            <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
              <span class="status-badge status-${st}">${d.currentStatus || statusLabel(st)}</span>
              ${canUpdate ? `<button class="btn btn-small" data-advance="1">Update Status</button>` : ""}
              <a class="btn ghost btn-small" href="load.html?id=${docc.id}">Open</a>
            </div>
          `;

          const btn = card.querySelector('[data-advance="1"]');
          if (btn) {
            btn.addEventListener("click", async () => {
              btn.disabled = true;

              const next =
                st === "accepted"
                  ? { status: "in_transit", currentStatus: "In Transit" }
                  : { status: "delivered", currentStatus: "Delivered" };

              try {
                await updateDoc(doc(db, "loads", docc.id), next);
                await loadShipments();
              } catch (e) {
                console.error(e);
                btn.disabled = false;
                alert("Could not update status.");
              }
            });
          }

          shipmentsList.appendChild(card);
        });

      } catch (e) {
        shipmentsEmpty.style.display = "block";
        shipmentsEmpty.textContent = "Error loading shipments";
        console.error(e);
      }
    }

    onAuthStateChanged(auth, async user => {
      currentUser = user || null;
      page.style.display = "block";
      await loadShipments();
    });
  </script>

</body>
</html>
